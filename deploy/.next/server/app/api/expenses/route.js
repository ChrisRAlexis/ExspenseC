"use strict";(()=>{var e={};e.id=879,e.ids=[879],e.modules={53524:e=>{e.exports=require("@prisma/client")},98432:e=>{e.exports=require("bcryptjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},2328:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{GET:()=>x,POST:()=>w});var i=r(49303),a=r(88716),n=r(60670),o=r(87070),p=r(75571),u=r(95456),l=r(13538),d=r(20629),c=r(55315),m=r(92048);async function x(e){let t=await (0,p.getServerSession)(u.L);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("status"),i={userId:t.user.id};s&&"ALL"!==s&&(i.status=s);let a=await l._.expense.findMany({where:i,orderBy:{createdAt:"desc"},include:{receipts:!0,items:!0}});return o.NextResponse.json({expenses:a})}async function w(e){let t=await (0,p.getServerSession)(u.L);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let r=await e.formData(),s=r.get("title"),i=r.get("description"),a=r.get("category"),n=r.get("tripName"),p=parseFloat(r.get("totalAmount"))||0,u=r.get("items"),x=r.get("status")||"DRAFT",w=u?JSON.parse(u):[],g=await l._.expense.create({data:{userId:t.user.id,title:s,description:i||null,category:a,tripName:n||null,totalAmount:p,status:x,submittedAt:"PENDING"===x?new Date:null,items:{create:w.map(e=>({description:e.description,amount:e.amount,category:e.category||null}))}},include:{items:!0}}),h=(0,c.join)(process.cwd(),"public","uploads",g.id);(0,m.existsSync)(h)||await (0,d.mkdir)(h,{recursive:!0});let q=[];for(let[e,t]of r.entries())if(e.startsWith("receipt_")&&t instanceof File){let e=await t.arrayBuffer(),r=Buffer.from(e),s=`${Date.now()}-${t.name}`,i=(0,c.join)(h,s);await (0,d.writeFile)(i,r),q.push(l._.receipt.create({data:{expenseId:g.id,imagePath:`/uploads/${g.id}/${s}`}}))}if(await Promise.all(q),"PENDING"===x){let e=await f(g,t.user.department);e&&await l._.expense.update({where:{id:g.id},data:{workflowId:e.id}})}let y=await l._.expense.findUnique({where:{id:g.id},include:{items:!0,receipts:!0}});return o.NextResponse.json({expense:y})}catch(e){return console.error("Failed to create expense:",e),o.NextResponse.json({error:"Failed to create expense"},{status:500})}}async function f(e,t){for(let r of(await l._.approvalWorkflow.findMany({where:{isActive:!0},include:{steps:!0}}))){if(!r.conditions)continue;let s=JSON.parse(r.conditions);if((!(s.departments?.length>0)||t&&s.departments.includes(t))&&(!s.minAmount||!(e.totalAmount<s.minAmount))&&(!s.maxAmount||!(e.totalAmount>s.maxAmount))){if(s.categories?.length>0&&!s.categories.includes(e.category))continue;return r}}return null}let g=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/expenses/route",pathname:"/api/expenses",filename:"route",bundlePath:"app/api/expenses/route"},resolvedPagePath:"/Users/chrisalexis/travel-expense-crm/src/app/api/expenses/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:q,serverHooks:y}=g,v="/api/expenses/route";function A(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:q})}},95456:(e,t,r)=>{r.d(t,{L:()=>o});var s=r(53797),i=r(98432),a=r.n(i),n=r(13538);let o={providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email and password are required");let t=await n._.user.findUnique({where:{email:e.email}});if(!t)throw Error("No user found with this email");if(!await a().compare(e.password,t.password))throw Error("Invalid password");return{id:t.id,email:t.email,name:t.name,role:t.role,department:t.department}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role,e.department=t.department),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.department=t.department),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},13538:(e,t,r)=>{r.d(t,{_:()=>i});var s=r(53524);let i=globalThis.prisma??new s.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,790,972],()=>r(2328));module.exports=s})();