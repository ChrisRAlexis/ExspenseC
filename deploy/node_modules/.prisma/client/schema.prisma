generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  password   String
  name       String
  role       String  @default("EMPLOYEE") // EMPLOYEE, APPROVER, ADMIN
  department String?

  // Manager relationship for approval chains
  managerId     String?
  manager       User?   @relation("ManagerRelation", fields: [managerId], references: [id])
  directReports User[]  @relation("ManagerRelation")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expenses        Expense[]
  approvalActions ApprovalAction[]
  workflowSteps   WorkflowStep[]
}

model Expense {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  title       String
  description String?
  totalAmount Float
  category    String // TRAVEL, MEALS, LODGING, TRANSPORTATION, OTHER
  tripName    String?
  status      String  @default("DRAFT") // DRAFT, PENDING, APPROVED, REJECTED, CHANGES_REQUESTED

  workflowId  String?
  workflow    ApprovalWorkflow? @relation(fields: [workflowId], references: [id])
  currentStep Int               @default(0)

  submittedAt DateTime?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items           ExpenseItem[]
  receipts        Receipt[]
  approvalActions ApprovalAction[]
}

model ExpenseItem {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  description String
  amount      Float
  category    String?
  createdAt   DateTime @default(now())
}

model Receipt {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  imagePath   String
  ocrData     String? // JSON string of extracted data
  vendorName  String?
  receiptDate DateTime?
  totalAmount Float?
  createdAt   DateTime  @default(now())
}

model ApprovalWorkflow {
  id        String  @id @default(cuid())
  name      String
  type      String // SEQUENTIAL, PARALLEL, MANAGER_CHAIN
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Default workflow for manager-based approvals

  // Conditions as JSON: { departments, minAmount, maxAmount, categories, escalateAt }
  // escalateAt: amount threshold to add additional approvers
  conditions String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps    WorkflowStep[]
  expenses Expense[]
}

model WorkflowStep {
  id         String           @id @default(cuid())
  workflowId String
  workflow   ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  approverId String? // null means "use employee's manager"
  approver   User?   @relation(fields: [approverId], references: [id])

  stepOrder  Int
  isRequired Boolean @default(true)

  // Escalation: only apply this step if amount >= threshold
  amountThreshold Float?

  createdAt DateTime @default(now())
}

model ApprovalAction {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  approverId String
  approver   User   @relation(fields: [approverId], references: [id])

  action     String // APPROVED, REJECTED, CHANGES_REQUESTED
  comments   String?
  stepNumber Int

  createdAt DateTime @default(now())
}
